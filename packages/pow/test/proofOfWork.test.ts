import { toTxBytes } from "@helixnetwork/converter";
import test from "ava";
import { powBundle, powTx } from "../src/proofOfWork";

const hashBytes = toTxBytes(
  "e11a4288943252a84f9aeffad344fec9da70ac5dde86b5df460a4d6362e6909f466615b00a0d9d7d1a147829252dd40c4289abf640748d6ecca5995492f708f70a10741e7414ccfcb0da2ea8366f6590aef337bc0f0541ce3ff7d3f4fdb9321c05821b9dce7911c72ccea29db0fb3d0de29ac821ea898851b4e26926be6b9999850ce3a979c5a27c3adc820d3e83320b54c301b5143df3f8121f648134878e99cbc0de6ab8dfde6d9c9e724712f34e36af0d1b51f1529549953c5654828733f0891b13e134a9fccaa94964a7620168ef524913f78c9a37f84bfbd84710bd475e6a7f032d7923c4c4c9ead134e6c9a123cf169cc814aeaa419af1886d08322c3b8a7fa5177729141ffaf66f3f5c7a7dce6c5ae7b65bb31f7bb882c3e8d99ecf50faf9821901b8364c4e293391050f40aaa57ec0b156aca81f32259c2cb86e74983e0215c951c645466bb1c32e251fc47aa8869b86a057426266f9c3ff1ad482b3ce9ba1f082ae220209b2b7e886b9080fd7f0832af6a0091608b05d143cedd86f9844268b1526c285780f2f31f6500f8e4a6915ddbca17e90a1c0f7069bf84a637c4f198f6dc6ce61178eaac2c4b8dae34a4ce86d7631f7030bf026057c9945aecf0e0cbd5325e48cde4038a64731a12bd7f81bf15006a3b2f6267b31652cc441d9ce779f727de464d5474f10578483c423f3e85a9765c3446798c817a22b0d9957a03f88dce62ae99adef45cd2315b5615d764cd3e64f87e3438ff29c1a3e6b3f9f2b09f831f9c16e0ba042d19ac716cc81ae2de5ab7c58f89810a4b16b83442e5ff0c08c1e3d7aceabab64790a4327409a195c2a614b12d658d73e23837345e3204e5afd1d60c8a14e4bb6c21682bdedc1b6c0800239cc91e79bfd0823fc3e66e4bd3ac53fb30394bb18cb4b94be9d7f73e399ceafa3b2bd91cc4e193f36987190a5bdfccbba0448fb1c275ca28899545c2aac70a37d0e713126d07ce3e15c02808f92f2383665d787697e7c8e9096a6434a93daa947b451b0aabbcdba9b5ca831bafec26e5ac6daed2e2e2ac26b4fd289d10a13824e0479574876d243f3411"
);

const bundle = [
  hashBytes,
  toTxBytes(
    "0d949c8f1448224dc740448da95ab5e708cd7b35f229d53184676ba2ab288035f582290b0336eb0ecc0762062d9cc78464f4c638c23466c82edd4fc7e23969559c2df3102f291a2fe42bb74813c61dd7cde43db2f6ca5b08231aab1b56c54efe87656f64d1fe190ab4ca01eca0c5bc5e6f3f9fde2af16b39c20cf5357eb352ce2fac7a0c03b713bef6b47dbb9fbf82e5aee0b6391a990f0bc0f3e2d095984dcd81bdba81476d5221f73cb885dcfcdca5a0924e7229a25d40a59419301ae9a6a75cead76101e1fd061b559fcca8e69ef4908f92a7dd69156f4ac27f2b513e4fa3164397bdf88d6d3055fee5c358130cab7dd4931c60ec3a926133ebd6bfaa0e0bf8911f0fd954960faf0618f5c662675e9843d2b90175e61aeda821f9b11e9960bd25f384b4b354cdc817f7b1ce2a990aca96f807b1de291cc564682ab6dc1a82176c68957d8e95dc5115fb36d273be352b2234ca87642d2916f01b8021fe2e142a5cabbd8c879fc18fcb0f013745b3ba8c66d2013c02e67ede310a20880772ed0fb191e61ee8fe9addede962e601ea58ee730ef0b064071d72d588f3488d22f553f4cb28d118d66726658dd7ccd421e0091c389e636a1384f80082f7fee781e275583d912caa94fd6feedee85a2dce4ec6f49e8ffc33a9e8ee5bf1530ff9e68e6b63841515ed561d4b095bc2054c4182c52aeb83c6c475cea1658b7a21ffb4181e69fe1f591b701f65364cb1c7deeb27d823ce9b2e336827b71b8909a07aa8e9e9d5cff92710e139fa851ae59cad437786f134c547690b46a6f0d1143a222ccf1e49bbe09590bd7c5c768ebb065723dc8993660f4675272c3a12fec463e7a7b7817fd1c51a24c23d702221c68a1cb521500ab86a056a0c011300ebf0d20afc53cb0d4489127d9cd231c0b37e31bf3ade7e39c06284cf28c52472dc7302419ad028ebe4063e71a8272b6f4853086c44d8699a359564a3cdaa368f6387b2e6ee15b9cb1c6e418223f700579649a0b828de9cbedf026ae941d66373865565450c84134b622f24f61823e71593fc8eafcf1055a246db02cc87a99b06e24ce3e7c9e9"
  ),
  toTxBytes(
    "e5308e57e19e378b5cdcd7d40ee80a3ba1ff56e10befe17b50a8f5597f24a82cc52b9f55a334e786bc55f2bf57710ccc68b4f46b6c18e2a0dbde415d5627488ca913bb9f9bf5e39e34112ed6c4312b6b045e82d896a822e30faf4b5fd98422e8e782e05afe05eef924b49b4a5f160c6d8582454bef3dd76d95b12f3a953cbfe5e9ac7cea86afd4271e7523b5569781b64d3e1ab4a3f0d0d38b6f2d9a7ae77e4aabec35fbef0dbc13698e2ad97c78dc83943ac8ae20472227007d21c25d0067c541a309ce7bcbbbf38080840fc7196494e7f38f539a3a9db07963380a74bcfecd4f66d71c6fede88190245ae3d05758a1a550aa88884b5d026f5c24b9dd73be538f7eb33a94b01c7bfd8ef0fc56fc1ed28187b40225a6cf94cfdb5fd7179ad3274fb69a43b7750ad8ddc17928bbbe7eb103564227f056ebd978ea464386463bc1f077614829be76757b2f592285d40902078710722c8f8bb6c050119cf34c7539683cf8643f38a1e8d60c86d5de111ab23cc991d261f91d9ef090f7900ae65126c1495f98d3db330d1f74f5e3159a001aa5d5cfb4d91d1721c3b10cc1dbe79b4398c1e306c11649723f5736a41b204ba11ce6da0d24d7de9aebd8969f5a8ea1b59fff7f086b095b2c4e42a93a07b740e2ca7b41d194d626d08cb5f0bfdfd3dd0b1b48790636d32dba1deefd179332f864b1754aaac238ddbabfba3d83a759441166c694b40bef069bada2e0f19c17aa152277ebb0072a2d75112a7b6151e0f1e56edb7da3d69fc3ecb669013ea51c20ac479eb517049b3f3101eeb7ee615043d434bc37830b6da0e82111df52553a64549a8a327d1b05ae6f85447d4cc05295d14f60b4ad1cafc35d8efdff94f44b110b6cb36ba0f33ed9328639b2ee3a792ea166c0eaba042cdd58cfcc8282f23fe7495f0e96b5f76096c15ff1837afef6151eb96406f1bfc36c006bc8300261d884d3ec051c7dd8b9e3a762c31c0d22e9d84699438a5ccf2c824d1c287c1676fb68a7dfbf7f8c07d39708532434671d2f8044ecef803db9c007b1512414f80c949d69d5b3cfed3c853cffeb60c1514bd338cc"
  )
];

test("powTx() finds correct nonce for hash.", async t => {
  t.is(
    await powTx(hashBytes, 2),
    "e11a4288943252a84f9aeffad344fec9da70ac5dde86b5df460a4d6362e6909f466615b00a0d9d7d1a147829252dd40c4289abf640748d6ecca5995492f708f70a10741e7414ccfcb0da2ea8366f6590aef337bc0f0541ce3ff7d3f4fdb9321c05821b9dce7911c72ccea29db0fb3d0de29ac821ea898851b4e26926be6b9999850ce3a979c5a27c3adc820d3e83320b54c301b5143df3f8121f648134878e99cbc0de6ab8dfde6d9c9e724712f34e36af0d1b51f1529549953c5654828733f0891b13e134a9fccaa94964a7620168ef524913f78c9a37f84bfbd84710bd475e6a7f032d7923c4c4c9ead134e6c9a123cf169cc814aeaa419af1886d08322c3b8a7fa5177729141ffaf66f3f5c7a7dce6c5ae7b65bb31f7bb882c3e8d99ecf50faf9821901b8364c4e293391050f40aaa57ec0b156aca81f32259c2cb86e74983e0215c951c645466bb1c32e251fc47aa8869b86a057426266f9c3ff1ad482b3ce9ba1f082ae220209b2b7e886b9080fd7f0832af6a0091608b05d143cedd86f9844268b1526c285780f2f31f6500f8e4a6915ddbca17e90a1c0f7069bf84a637c4f198f6dc6ce61178eaac2c4b8dae34a4ce86d7631f7030bf026057c9945aecf0e0cbd5325e48cde4038a64731a12bd7f81bf15006a3b2f6267b31652cc441d9ce779f727de464d5474f10578483c423f3e85a9765c3446798c817a22b0d9957a03f88dce62ae99adef45cd2315b5615d764cd3e64f87e3438ff29c1a3e6b3f9f2b09f831f9c16e0ba042d19ac716cc81ae2de5ab7c58f89810a4b16b83442e5ff0c08c1e3d7aceabab64790a4327409a195c2a614b12d658d73e23837345e3204e5afd1d60c8a14e4bb6c21682bdedc1b6c0800239cc91e79bfd0823fc3e66e4bd3ac53fb30394bb18cb4b94be9d7f73e399ceafa3b2bd91cc4e193f36987190a5bdfccbba0448fb1c275ca28899545c2aac70a37d0e713126d07ce3e15c02808f92f2383665d787697e7c8e9096a6434a93daa947b451b0aabbcdba9b5ca0000000000000895aed2e2e2ac26b4fd289d10a13824e0479574876d243f3411",
    "powTx() should find correct nonce for hash."
  );
});

test("powBundle() finds correct nonce for multiple hashes", async t => {
  t.deepEqual(
    await powBundle(bundle, 2),
    [
      "e11a4288943252a84f9aeffad344fec9da70ac5dde86b5df460a4d6362e6909f466615b00a0d9d7d1a147829252dd40c4289abf640748d6ecca5995492f708f70a10741e7414ccfcb0da2ea8366f6590aef337bc0f0541ce3ff7d3f4fdb9321c05821b9dce7911c72ccea29db0fb3d0de29ac821ea898851b4e26926be6b9999850ce3a979c5a27c3adc820d3e83320b54c301b5143df3f8121f648134878e99cbc0de6ab8dfde6d9c9e724712f34e36af0d1b51f1529549953c5654828733f0891b13e134a9fccaa94964a7620168ef524913f78c9a37f84bfbd84710bd475e6a7f032d7923c4c4c9ead134e6c9a123cf169cc814aeaa419af1886d08322c3b8a7fa5177729141ffaf66f3f5c7a7dce6c5ae7b65bb31f7bb882c3e8d99ecf50faf9821901b8364c4e293391050f40aaa57ec0b156aca81f32259c2cb86e74983e0215c951c645466bb1c32e251fc47aa8869b86a057426266f9c3ff1ad482b3ce9ba1f082ae220209b2b7e886b9080fd7f0832af6a0091608b05d143cedd86f9844268b1526c285780f2f31f6500f8e4a6915ddbca17e90a1c0f7069bf84a637c4f198f6dc6ce61178eaac2c4b8dae34a4ce86d7631f7030bf026057c9945aecf0e0cbd5325e48cde4038a64731a12bd7f81bf15006a3b2f6267b31652cc441d9ce779f727de464d5474f10578483c423f3e85a9765c3446798c817a22b0d9957a03f88dce62ae99adef45cd2315b5615d764cd3e64f87e3438ff29c1a3e6b3f9f2b09f831f9c16e0ba042d19ac716cc81ae2de5ab7c58f89810a4b16b83442e5ff0c08c1e3d7aceabab64790a4327409a195c2a614b12d658d73e23837345e3204e5afd1d60c8a14e4bb6c21682bdedc1b6c0800239cc91e79bfd0823fc3e66e4bd3ac53fb30394bb18cb4b94be9d7f73e399ceafa3b2bd91cc4e193f36987190a5bdfccbba0448fb1c275ca28899545c2aac70a37d0e713126d07ce3e15c02808f92f2383665d787697e7c8e9096a6434a93daa947b451b0aabbcdba9b5ca0000000000000895aed2e2e2ac26b4fd289d10a13824e0479574876d243f3411",
      "0d949c8f1448224dc740448da95ab5e708cd7b35f229d53184676ba2ab288035f582290b0336eb0ecc0762062d9cc78464f4c638c23466c82edd4fc7e23969559c2df3102f291a2fe42bb74813c61dd7cde43db2f6ca5b08231aab1b56c54efe87656f64d1fe190ab4ca01eca0c5bc5e6f3f9fde2af16b39c20cf5357eb352ce2fac7a0c03b713bef6b47dbb9fbf82e5aee0b6391a990f0bc0f3e2d095984dcd81bdba81476d5221f73cb885dcfcdca5a0924e7229a25d40a59419301ae9a6a75cead76101e1fd061b559fcca8e69ef4908f92a7dd69156f4ac27f2b513e4fa3164397bdf88d6d3055fee5c358130cab7dd4931c60ec3a926133ebd6bfaa0e0bf8911f0fd954960faf0618f5c662675e9843d2b90175e61aeda821f9b11e9960bd25f384b4b354cdc817f7b1ce2a990aca96f807b1de291cc564682ab6dc1a82176c68957d8e95dc5115fb36d273be352b2234ca87642d2916f01b8021fe2e142a5cabbd8c879fc18fcb0f013745b3ba8c66d2013c02e67ede310a20880772ed0fb191e61ee8fe9addede962e601ea58ee730ef0b064071d72d588f3488d22f553f4cb28d118d66726658dd7ccd421e0091c389e636a1384f80082f7fee781e275583d912caa94fd6feedee85a2dce4ec6f49e8ffc33a9e8ee5bf1530ff9e68e6b63841515ed561d4b095bc2054c4182c52aeb83c6c475cea1658b7a21ffb4181e69fe1f591b701f65364cb1c7deeb27d823ce9b2e336827b71b8909a07aa8e9e9d5cff92710e139fa851ae59cad437786f134c547690b46a6f0d1143a222ccf1e49bbe09590bd7c5c768ebb065723dc8993660f4675272c3a12fec463e7a7b7817fd1c51a24c23d702221c68a1cb521500ab86a056a0c011300ebf0d20afc53cb0d4489127d9cd231c0b37e31bf3ade7e39c06284cf28c52472dc7302419ad028ebe4063e71a8272b6f4853086c44d8699a359564a3cdaa368f6387b2e6ee15b9cb1c6e418223f700579649a0b828de9cbedf026ae941d66373865565450c840000000000009ad3e71593fc8eafcf1055a246db02cc87a99b06e24ce3e7c9e9",
      "e5308e57e19e378b5cdcd7d40ee80a3ba1ff56e10befe17b50a8f5597f24a82cc52b9f55a334e786bc55f2bf57710ccc68b4f46b6c18e2a0dbde415d5627488ca913bb9f9bf5e39e34112ed6c4312b6b045e82d896a822e30faf4b5fd98422e8e782e05afe05eef924b49b4a5f160c6d8582454bef3dd76d95b12f3a953cbfe5e9ac7cea86afd4271e7523b5569781b64d3e1ab4a3f0d0d38b6f2d9a7ae77e4aabec35fbef0dbc13698e2ad97c78dc83943ac8ae20472227007d21c25d0067c541a309ce7bcbbbf38080840fc7196494e7f38f539a3a9db07963380a74bcfecd4f66d71c6fede88190245ae3d05758a1a550aa88884b5d026f5c24b9dd73be538f7eb33a94b01c7bfd8ef0fc56fc1ed28187b40225a6cf94cfdb5fd7179ad3274fb69a43b7750ad8ddc17928bbbe7eb103564227f056ebd978ea464386463bc1f077614829be76757b2f592285d40902078710722c8f8bb6c050119cf34c7539683cf8643f38a1e8d60c86d5de111ab23cc991d261f91d9ef090f7900ae65126c1495f98d3db330d1f74f5e3159a001aa5d5cfb4d91d1721c3b10cc1dbe79b4398c1e306c11649723f5736a41b204ba11ce6da0d24d7de9aebd8969f5a8ea1b59fff7f086b095b2c4e42a93a07b740e2ca7b41d194d626d08cb5f0bfdfd3dd0b1b48790636d32dba1deefd179332f864b1754aaac238ddbabfba3d83a759441166c694b40bef069bada2e0f19c17aa152277ebb0072a2d75112a7b6151e0f1e56edb7da3d69fc3ecb669013ea51c20ac479eb517049b3f3101eeb7ee615043d434bc37830b6da0e82111df52553a64549a8a327d1b05ae6f85447d4cc05295d14f60b4ad1cafc35d8efdff94f44b110b6cb36ba0f33ed9328639b2ee3a792ea166c0eaba042cdd58cfcc8282f23fe7495f0e96b5f76096c15ff1837afef6151eb96406f1bfc36c006bc8300261d884d3ec051c7dd8b9e3a762c31c0d22e9d84699438a5ccf2c824d1c287c1676fb68a7dfbf7f8c07d39708532434671d2f80440000000000006ed1512414f80c949d69d5b3cfed3c853cffeb60c1514bd338cc"
    ],
    "powBundle() should find correct nonce for bundle."
  );
});

test("powTx() with invalid hash.", async t => {
  let errorMessage;
  // @ts-ignore
  await powTx(null, 2).catch((error: Error) => (errorMessage = error.message));

  t.is(
    errorMessage,
    "Illegal txBytes length: null",
    "powTx() throw error message because of invalid hash."
  );
});

test("powTx() invalid min difficulty.", async t => {
  let errorMessage;
  // @ts-ignore
  await powTx(hashBytes, 0).catch(
    (error: Error) => (errorMessage = error.message)
  );

  t.is(
    errorMessage,
    "Illegal difficulty: 0",
    "powTx() throw error message because of min difficulty."
  );
});

test("powTx() invalid max difficulty.", async t => {
  let errorMessage;
  // @ts-ignore
  await powTx(hashBytes, 32).catch(
    (error: Error) => (errorMessage = error.message)
  );

  t.is(
    errorMessage,
    "Illegal difficulty: 256",
    "powTx() throw error message because of max difficulty."
  );
});

test("powTx() invalid hash length.", async t => {
  let errorMessage;
  // @ts-ignore
  await powTx(new Uint8Array(769), 2).catch(
    (error: Error) => (errorMessage = error.message)
  );

  t.is(
    errorMessage,
    "Illegal txBytes length: 769",
    "powTx() throw error message because of max difficulty."
  );
});
